trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

variables:
  tag: '$(Build.BuildId)'
  image: sierrasoftworks/rex-ui
  namespace.staging: rex-staging
  namespace.prod: rex-prod

stages:
- stage: build
  displayName: Build
  jobs:  
  - job: build_docker
    displayName: Build Docker Image
    steps:
    - task: Docker@2
      displayName: Build Docker Image
      inputs:
        command: buildAndPush
        dockerfile: 'Dockerfile'
        containerRegistry: Docker Hub
        repository: $(image)
        tags: |
          latest
          $(tag)

    - publish: ./.deploy
      artifact: manifests

- stage: deploy_staging
  displayName: Deploy (Staging)
  dependsOn:
    - build
  jobs:
    - deployment: deploy_staging
      displayName: Deploy Staging
      environment: staging-rex-sierrasoftworks-com.rex-staging
      strategy:
        runOnce:
          deploy:
            steps:
              - task: KubernetesManifest@0
                name: deploy
                displayName: Deploy 
                inputs:
                  action: deploy
                  namespace: $(namespace.staging)
                  manifests: manifests/*.yml

                  containers: |
                    $(image):$(tag)

- stage: deploy_prod
  displayName: Deploy (Production)
  dependsOn:
    - build
    - deploy_staging
  jobs:
    - deployment: deploy_prod
      displayName: Deploy Production
      environment: rex-sierrasoftworks-com.rex-prod
      strategy:
        runOnce:
          deploy:
            steps:
              - task: KubernetesManifest@0
                name: deploy
                displayName: Deploy 
                inputs:
                  action: deploy
                  namespace: $(namespace.prod)
                  manifests: manifests/*.yml
                  containers: |
                    $(image):$(tag)